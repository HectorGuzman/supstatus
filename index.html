<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SUP Status - La Herradura</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="styles.css">
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations?.().then((regs) => {
        regs.forEach((reg) => reg.unregister());
      });
    }
  </script>
</head>
<body id="top">
  <header class="top-bar container">
    <div class="top-actions">
      <button type="button" class="top-avatar-trigger" id="profile-link" aria-label="Abrir perfil">
        <img id="auth-header-avatar" class="top-avatar" src="logosupstatus.png" alt="Avatar SUP" />
        <span class="top-avatar-label">Mi perfil</span>
      </button>
      <button class="ghost story-create-trigger" data-story-open>‚ú® Compartir historia</button>
      <button class="ghost" id="auth-button">üîê Iniciar sesi√≥n</button>
    </div>
  </header>

  <main class="layout">
    <section class="hero container">
      <div class="hero-copy">
        <img src="Logos/SUP_Experience_Variables(horizontal)_Hor_Base.png" alt="SUP Status logo" class="hero-logo">
        <span class="hero-tagline">Condiciones para tu remada</span>
        <p class="subtitle">Condiciones confiables, mareas y ventanas ideales para remar con tranquilidad en La Herradura.</p>
        <div class="hero-actions">
          <button class="primary" onclick="verCondicionesActuales()">‚è±Ô∏è ¬øPuedo remar ahora?</button>
          <button class="ghost" onclick="compartirInfo()">üì§ Compartir reporte</button>
        </div>
        <span id="auth-greeting" class="hero-greeting">üåä Conecta tu perfil SUP y guarda tus remadas favoritas</span>
      </div>
      <div class="hero-card" id="estado-actual">
        <div class="hero-card-header">
          <span class="hero-card-eyebrow">Siguiente ventana ideal</span>
          <span class="hero-card-chip" id="estado-nivel">‚Äî</span>
        </div>
        <h3 id="estado-hora">--:-- hrs</h3>
        <p id="estado-detalle">Esperando pron√≥stico‚Ä¶</p>
        <div class="hero-card-metrics">
          <span id="estado-viento">üå¨Ô∏è --</span>
          <span id="estado-oleaje">üåä --</span>
        </div>
      </div>
    </section>

    <section class="info-band container">
      <div id="fecha" class="info-chip">üìÖ Cargando fecha‚Ä¶</div>
      <div id="horarios-sol" class="info-chip">üåÖ Calculando sol‚Ä¶</div>
      <div id="generado-el" class="info-chip">üïí Actualizando datos‚Ä¶</div>
    </section>

    <section class="forecast container">
      <div class="forecast-header">
        <h2 class="section-title">Pron√≥stico por bloque ¬∑ La Herradura</h2>
        <div class="forecast-controls">
          <div id="selector-dia" class="segmented">
            <button data-dia="hoy" class="activo" onclick="cambiarDia('hoy')">Hoy</button>
            <button data-dia="ma√±ana" onclick="cambiarDia('ma√±ana')">Ma√±ana</button>
          </div>
          <button class="ghost" onclick="alternarModo()">üåì Modo oscuro</button>
        </div>
      </div>
      <div class="cards-grid" id="pronostico"></div>
    </section>

    <section class="insights container">
      <div class="insights-card">
        <h2>Mareas pr√≥ximas</h2>
        <p class="insights-subtitle">Mant√©n a la vista los pr√≥ximos eventos de marea para ajustar tu salida.</p>
        <div id="horarios-marea" class="marea-chips">Cargando mareas‚Ä¶</div>
      </div>
      <div class="insights-card">
        <h2>Consejo r√°pido</h2>
        <p class="insights-tip">‚ö†Ô∏è Usa chaleco salvavidas, verifica el spot en terreno y navega de forma responsable. Revisa siempre las condiciones al llegar.</p>
      </div>
    </section>

    <section class="stories-section container" id="stories-section">
      <div class="stories-wrapper">
        <div class="stories-header">
          <div>
            <h2 class="section-title">Historias SUP</h2>
            <p class="stories-subtitle">Descubre c√≥mo la comunidad vive el SUP y encuentra inspiraci√≥n para tu pr√≥xima remada.</p>
          </div>
          <button class="ghost" id="stories-refresh-button" aria-label="Actualizar historias">üîÑ Actualizar</button>
        </div>
        <div class="stories-content" id="stories-content">
          <div class="stories-empty" id="stories-empty">
            <p>üìò A√∫n no hay historias destacadas. ¬°Comparte la tuya desde tu perfil!</p>
          </div>
          <div class="stories-grid" id="stories-grid"></div>
        </div>
      </div>
    </section>
  </main>

  <footer class="container">
    <div class="footer-panel">
      <p class="creditos">Hecho con ‚ù§Ô∏è por <a href="https://instagram.com/__jokerguzman" target="_blank" rel="noopener">@__jokerguzman</a></p>
      <div class="support-row">
        <span class="support-copy">¬øTe gusta el proyecto?</span>
        <a class="bmc-button" href="https://buymeacoffee.com/jokerguzman" target="_blank" rel="noopener" aria-label="Inv√≠tanos un caf√© en Buy Me a Coffee">
          ‚òï <span>Inv√≠tanos un caf√©</span>
        </a>
      </div>
    </div>
  </footer>

  <div id="auth-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content auth-modal">
      <button type="button" class="cerrar-modal" onclick="window.closeAuthModal()">‚úï</button>
      <h3 class="modal-title">Inicia sesi√≥n</h3>
      <p class="modal-copy">Guarda tus sesiones y personaliza tu experiencia SUP.</p>
      <div class="auth-options">
        <button type="button" class="primary" id="google-login-btn">‚ú® Continuar con Google</button>
        <div class="auth-divider">
          <span></span>
          <em>o con email</em>
          <span></span>
        </div>
        <label class="auth-input">
          Email
          <input type="email" id="email-input" placeholder="tu@correo.com">
        </label>
        <label class="auth-input">
          Contrase√±a
          <input type="password" id="password-input" placeholder="m√≠nimo 6 caracteres">
        </label>
        <button type="button" class="ghost" id="email-login-btn">Ingresar / Crear cuenta</button>
        <button type="button" class="ghost" id="reset-password-btn">¬øOlvidaste tu contrase√±a?</button>
        <p class="auth-hint">Te enviaremos correos de verificaci√≥n y recuperaci√≥n cuando sea necesario.</p>
        <p class="auth-error" id="auth-error"></p>
      </div>
    </div>
  </div>

  <div id="profile-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content profile-modal">
      <button type="button" class="cerrar-modal" onclick="window.closeProfileModal()">‚úï</button>
      <h3 class="modal-title">Mi perfil</h3>
      <p class="profile-email" id="profile-email"></p>
      <div class="profile-avatar">
        <img id="profile-avatar-preview" src="logosupstatus.png" alt="Avatar SUP" class="profile-avatar-img">
        <label class="profile-avatar-upload">
          <input type="file" id="profile-avatar-input" accept="image/*">
          <span>Subir foto de perfil</span>
        </label>
        <span class="profile-avatar-status" id="profile-avatar-status"></span>
      </div>
      <div class="profile-form">
        <label>
          Nombre para mostrar
          <input id="profile-displayName" type="text" placeholder="Tu nombre o apodo">
        </label>
        <label>
          Nivel de experiencia
          <select id="profile-experienceLevel">
            <option value="">Selecciona tu nivel</option>
            <option value="Inicio reciente">Inicio reciente</option>
            <option value="Intermedio ¬∑ sesiones regulares">Intermedio ¬∑ sesiones regulares</option>
            <option value="Avanzado ¬∑ largas distancias">Avanzado ¬∑ largas distancias</option>
            <option value="Competencia / instructor">Competencia / instructor</option>
          </select>
        </label>
        <label>
          Modalidad favorita
          <select id="profile-favoriteDiscipline">
            <option value="">¬øQu√© te motiva m√°s?</option>
            <option value="Placer / recreacional">Placer / recreacional</option>
            <option value="Racing / resistencia">Racing / resistencia</option>
            <option value="Downwind / mar abierto">Downwind / mar abierto</option>
            <option value="SUP surf">SUP surf</option>
            <option value="SUP yoga / fitness">SUP yoga / fitness</option>
            <option value="Exploraci√≥n / traves√≠as">Exploraci√≥n / traves√≠as</option>
          </select>
        </label>
        <label>
          Equipo principal
          <input id="profile-boardSetup" type="text" placeholder="Tabla, remo u otros detalles clave">
        </label>
        <label>
          Bio
          <textarea id="profile-bio" rows="3" placeholder="Comparte un poco sobre tu experiencia SUP"></textarea>
        </label>
        <label>
          Objetivo actual en el SUP
          <textarea id="profile-goals" rows="3" placeholder="Cu√©ntanos qu√© te gustar√≠a lograr remando"></textarea>
        </label>
        <label>
          Rutina o enfoque actual
          <textarea id="profile-practiceFocus" rows="2" placeholder="Ej: mejorar t√©cnica de giro, preparar traves√≠a, m√°s equilibrio, etc."></textarea>
        </label>
      </div>
      <div class="profile-actions">
        <button class="primary" id="profile-save">Guardar perfil</button>
        <span class="profile-status" id="profile-status"></span>
      </div>
    <div class="admin-section" id="admin-section" style="display: none;">
      <h4>Perfiles registrados</h4>
      <p class="admin-hint">Solo el equipo puede ver esta vista.</p>
      <div class="admin-metrics" id="admin-metrics"></div>
      <div class="admin-list" id="admin-profile-list"></div>
    </div>
  </div>
  </div>

  <div id="modal-actual" class="modal-overlay" style="display: none;">
    <div class="modal-content" id="modal-contenido">
      <button onclick="cerrarModal()" class="cerrar-modal">‚úï</button>
    </div>
  </div>

  <div id="story-create-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content story-create-modal">
      <button type="button" class="cerrar-modal" id="story-create-close">‚úï</button>
      <div class="story-editor">
        <div class="story-editor-header">
          <h4>Comparte tu momento SUP</h4>
          <p>Cuenta c√≥mo estuvo tu sesi√≥n, agrega una foto y un spot cercano.</p>
        </div>
        <label class="story-editor-comment">
          Comentario
          <textarea id="story-body" rows="4" placeholder="¬øC√≥mo estuvo tu remada hoy?"></textarea>
        </label>
        <div class="story-location">
          <div class="story-location-actions">
            <button class="ghost story-location-btn" type="button" id="story-location-button">üìç Obtener sugerencias cercanas</button>
            <button class="ghost story-location-clear" type="button" id="story-location-clear" style="display: none;">‚úï Quitar sugerencia</button>
          </div>
          <span class="story-location-status" id="story-location-status"></span>
          <div class="story-location-suggestions" id="story-location-suggestions"></div>
        </div>
        <div class="story-editor-media">
          <div class="story-media-controls">
            <label class="story-media-upload">
              <input type="file" id="story-media-input" accept="image/*">
              <span>üì∑ Subir foto (opcional)</span>
            </label>
            <button class="ghost story-media-remove" type="button" id="story-media-remove" disabled>Quitar foto</button>
          </div>
          <div class="story-media-preview-wrapper" id="story-media-preview-wrapper" style="display: none;">
            <img id="story-media-preview" class="story-media-preview" src="" alt="Vista previa de la historia">
          </div>
          <span class="story-media-status" id="story-media-status"></span>
        </div>
        <div class="story-editor-actions">
          <button class="ghost" type="button" id="story-reset">Restablecer</button>
          <button class="primary" type="button" id="story-save">Compartir historia</button>
          <span class="story-editor-status" id="story-status"></span>
        </div>
        <p class="story-editor-meta" id="story-meta"></p>
        <div class="story-history">
          <div class="story-history-header">
            <h5>Mis historias</h5>
            <span class="story-history-count" id="user-story-count">0</span>
          </div>
          <div class="story-history-list" id="user-story-list"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="story-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content story-modal">
      <button type="button" class="cerrar-modal" id="story-modal-close">‚úï</button>
      <div class="story-modal-body">
        <div class="story-modal-media" id="story-modal-media" aria-hidden="true"></div>
        <div class="story-modal-copy">
          <span class="story-modal-tag" id="story-modal-featured" style="display: none;">‚≠ê Destacada</span>
          <h3 id="story-modal-title"></h3>
          <p class="story-modal-author" id="story-modal-author"></p>
          <div class="story-modal-meta" id="story-modal-meta"></div>
          <div class="story-modal-actions">
            <button type="button" class="story-like-btn" id="story-modal-like-btn" aria-pressed="false">
              <span class="like-icon">‚ù§Ô∏è</span>
              <span class="like-count" id="story-modal-like-count">0</span>
            </button>
          </div>
          <p class="story-modal-text" id="story-modal-text"></p>
        </div>
      </div>
    </div>
  </div>

  <button type="button" class="story-create-fab" data-story-open aria-label="Compartir historia">‚ú® Compartir</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let pronostico;
    let diaActual = "hoy";
    let miniMaps = [];
    const estadoHoraEl = document.getElementById('estado-hora');
    const estadoNivelEl = document.getElementById('estado-nivel');
    const estadoDetalleEl = document.getElementById('estado-detalle');
    const estadoVientoEl = document.getElementById('estado-viento');
    const estadoOleajeEl = document.getElementById('estado-oleaje');

    const lat = -29.983059;
    const lon = -71.365225;
    function initializeMiniMap(mapId, direccionGrados) {
      const container = document.getElementById(mapId);
      if (!container || Number.isNaN(direccionGrados)) return;
      const miniMap = L.map(container, {
        attributionControl: false,
        zoomControl: false,
        dragging: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        boxZoom: false,
        keyboard: false,
        tap: false,
      }).setView([lat, lon], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
      }).addTo(miniMap);
      const iconoMini = L.divIcon({
        className: 'mini-wind-marker',
        html: `<div class="mini-wind-arrow" style="transform: rotate(${direccionGrados}deg);"></div>`,
      });
      L.marker([lat, lon], { icon: iconoMini }).addTo(miniMap);
      miniMaps.push(miniMap);
      setTimeout(() => miniMap.invalidateSize(), 120);
    }

    function actualizarFechaVisor(fecha, etiqueta) {
      const fechaElemento = document.getElementById("fecha");
      if (!fechaElemento) return;
      const formatoFecha = fecha.toLocaleDateString('es-CL', { weekday: 'long', day: 'numeric', month: 'long' });
      const capitalizada = formatoFecha.charAt(0).toUpperCase() + formatoFecha.slice(1);
      fechaElemento.innerHTML = `<strong>üìÖ ${etiqueta}:</strong> ${capitalizada}`;
    }

    function cleanupMiniMaps() {
      miniMaps.forEach((mapInstance) => {
        try {
          mapInstance.remove();
        } catch (_error) {}
      });
      miniMaps = [];
    }

    function getFeaturedIndex(blocks, dia) {
      if (!Array.isArray(blocks) || !blocks.length) return 0;
      if (dia !== 'hoy') return 0;
      const now = new Date();
      const currentHour = now.getHours();
      let index = blocks.findIndex((item) => {
        const hour = Number.parseInt((item.hora || '').split(':')[0], 10);
        return !Number.isNaN(hour) && hour >= currentHour;
      });
      if (index === -1) index = blocks.length - 1;
      return Math.max(index, 0);
    }

    function actualizarEstadoActualCard(item) {
      if (!item || !estadoHoraEl) return;
      estadoHoraEl.textContent = `${item.hora || '--:--'} hrs`;
      if (estadoNivelEl) estadoNivelEl.textContent = item.nivel || '‚Äî';
      if (estadoDetalleEl) estadoDetalleEl.textContent = item.condiciones || 'Mantente atento a las actualizaciones.';
      if (estadoVientoEl) estadoVientoEl.textContent = `üå¨Ô∏è ${item.viento || '--'}`;
      if (estadoOleajeEl) estadoOleajeEl.textContent = `üåä ${item.oleaje || '--'}`;
    }

    function renderizarPronostico(dia) {
      if (!pronostico || !pronostico[dia]) return;
      diaActual = dia;

      document.querySelectorAll('#selector-dia button').forEach(btn => {
        const activo = btn.dataset.dia === dia;
        btn.classList.toggle('activo', activo);
      });

      const hoy = new Date();
      const fecha = new Date(hoy);
      if (dia === "ma√±ana") {
        fecha.setDate(hoy.getDate() + 1);
      }
      actualizarFechaVisor(fecha, dia === "ma√±ana" ? "Ma√±ana" : "Hoy");
      mostrarHorariosSol(fecha);

      const contenedor = document.getElementById("pronostico");
      if (!contenedor) return;
      contenedor.innerHTML = "";

      cleanupMiniMaps();

      const bloques = pronostico[dia];
      const highlightedIndex = getFeaturedIndex(bloques, dia);

      bloques.forEach((item, i) => {
        const card = document.createElement("article");
        card.className = "card";

        if (i === highlightedIndex) {
          card.classList.add('featured');
        }

        card.style.animationDelay = `${i * 0.08}s`;

        const nivelClass = item.nivel.toLowerCase();
        const mapId = `mini-map-${dia}-${i}`;

        card.innerHTML = `
          <div class="card-header">
            <span class="hora">${item.hora} hrs</span>
            <span class="nivel-pill ${nivelClass}">${item.nivel}</span>
          </div>
          <div class="metrics">
            <div class="metric">
              <span class="label">Viento</span>
              <span class="value">${item.viento}</span>
              <span class="hint">${item.direccionViento}</span>
            </div>
            <div class="metric">
              <span class="label">Oleaje</span>
              <span class="value">${item.oleaje}</span>
              <span class="hint">${item.direccionOleaje}</span>
            </div>
            <div class="metric">
              <span class="label">Temperatura del agua</span>
              <span class="value">${item.temperatura}</span>
            </div>
          </div>
          <div class="card-map">
            <div class="card-map-header">
              <span>Direcci√≥n del viento</span>
            </div>
            <div class="mini-map" id="${mapId}" aria-hidden="true"></div>
            <span class="mini-map-note">Viento: ${item.direccionViento}</span>
          </div>
          <p class="condiciones">${item.condiciones}</p>
        `;

        contenedor.appendChild(card);
        initializeMiniMap(mapId, Number.parseInt(item.direccionVientoGrados, 10));
      });

      actualizarEstadoActualCard(bloques[highlightedIndex]);
    }

    function cambiarDia(valor) {
      renderizarPronostico(valor);
    }

    function alternarModo() {
      document.body.classList.toggle("oscuro");
      localStorage.setItem("modoOscuro", document.body.classList.contains("oscuro"));
    }

    function compartirInfo() {
      const texto = 'Revisa las condiciones en SUP Status - La Herradura: ' + window.location.href;
      if (navigator.share) {
        navigator.share({ title: 'SUP Status - La Herradura', text: texto, url: window.location.href });
      } else {
        alert("Tu navegador no soporta la funci√≥n de compartir.");
      }
    }

    function mostrarHorariosSol(fechaBase) {
      const solContainer = document.getElementById("horarios-sol");
      if (!solContainer) return;
      const { sunrise, sunset } = SunCalc.getTimes(fechaBase, lat, lon);
      const formatoHora = hora => hora.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' });
      solContainer.innerHTML = `<strong>üåÖ Sol:</strong> ${formatoHora(sunrise)} ¬∑ ${formatoHora(sunset)}`;
    }

    function mostrarHorariosMarea(data) {
      const mareaContainer = document.getElementById("horarios-marea");
      if (!mareaContainer) return;
      if (!data.mareas || data.mareas.length === 0) {
        mareaContainer.innerHTML = `<span class="marea-pill marea-pill--empty">üåÄ Sin mareas disponibles</span>`;
        return;
      }

      const iconos = { alta: "üåä‚¨ÜÔ∏è", baja: "üåä‚¨áÔ∏è" };
      const chips = data.mareas
        .slice(0, 6)
        .map(m => `<span class="marea-pill">${iconos[m.tipo] || "üåä"} ${m.tipo} ${m.hora}</span>`)
        .join("");

      mareaContainer.innerHTML = chips;
    }

    const STORIES_API_BASE = window.location.hostname === 'localhost'
      ? 'http://localhost:8080'
      : 'https://sup-experience-backend-mhhf2ac76q-ue.a.run.app';
    const storiesState = { stories: [], loading: false, pendingLikes: new Set() };
    const storiesGrid = document.getElementById('stories-grid');
    const storiesEmpty = document.getElementById('stories-empty');
    const storiesRefreshButton = document.getElementById('stories-refresh-button');
    const storyModal = document.getElementById('story-modal');
    const storyModalClose = document.getElementById('story-modal-close');
    const storyCreateModal = document.getElementById('story-create-modal');
    const storyCreateButtons = Array.from(document.querySelectorAll('[data-story-open]'));
    const storyCreateCloseButton = document.getElementById('story-create-close');
    const storyModalMedia = document.getElementById('story-modal-media');
    const storyModalTitle = document.getElementById('story-modal-title');
    const storyModalAuthor = document.getElementById('story-modal-author');
    const storyModalMeta = document.getElementById('story-modal-meta');
    const storyModalText = document.getElementById('story-modal-text');
    const storyModalFeatured = document.getElementById('story-modal-featured');
    const storyModalLikeButton = document.getElementById('story-modal-like-btn');
    const storyModalLikeCount = document.getElementById('story-modal-like-count');
    let currentModalStoryId = null;

    function escapeHtml(value = '') {
      return value
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatStoryDate(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      if (Number.isNaN(date.getTime())) return '';
      return date.toLocaleDateString('es-CL', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function buildExcerpt(text = '', maxLength = 160) {
      const trimmed = text.trim();
      if (!trimmed) return '';
      if (trimmed.length <= maxLength) return trimmed;
      const slice = trimmed.slice(0, maxLength);
      return `${slice.replace(/\s+\S*$/, '')}‚Ä¶`;
    }

    function safeMediaUrl(value) {
      if (typeof value !== 'string') return '';
      const url = value.trim();
      if (!/^https?:\/\//i.test(url)) return '';
      return url;
    }

    function storyTimestamp(story) {
      const source = story.publishedAt || story.updatedAt || story.createdAt;
      if (!source) return 0;
      const date = new Date(source);
      return Number.isNaN(date.getTime()) ? 0 : date.getTime();
    }

    function renderStories(stories) {
      if (!storiesGrid) return;
      storiesGrid.innerHTML = '';
      if (!stories || !stories.length) {
        if (storiesEmpty) {
          storiesEmpty.style.display = 'block';
          storiesEmpty.innerHTML = '<p>üìò A√∫n no hay historias destacadas. ¬°Comparte la tuya desde tu perfil!</p>';
        }
        return;
      }
      if (storiesEmpty) storiesEmpty.style.display = 'none';
      const sorted = [...stories].sort((a, b) => {
        if (Boolean(a.featured) !== Boolean(b.featured)) {
          return b.featured ? 1 : -1;
        }
        return storyTimestamp(b) - storyTimestamp(a);
      });
      sorted.forEach((story) => {
        const card = document.createElement('article');
        card.className = 'story-card';
        const excerpt = buildExcerpt(story.body || '');
        const dateLabel = formatStoryDate(story.publishedAt || story.updatedAt || story.createdAt);
        const mediaUrl = safeMediaUrl(story.mediaUrl);
        const likes = Number.isFinite(story.likes) ? story.likes : 0;
        const isLiked = Boolean(story.liked);
        const isLoadingLike = storiesState.pendingLikes.has(story.id);
        card.innerHTML = `
          <div class="story-card-media">
            ${mediaUrl ? `<img src="${escapeHtml(mediaUrl)}" alt="Historia SUP" loading="lazy">` : '<span>üåä</span>'}
          </div>
          <div class="story-card-body">
            <span class="story-card-author">${escapeHtml(story.authorName || 'Remador SUP')}</span>
            <h3 class="story-card-title">${escapeHtml(story.title || 'Historia SUP')}</h3>
            <p class="story-card-excerpt">${escapeHtml(excerpt || 'Descubre c√≥mo viven SUP en La Herradura.')}</p>
            <div class="story-card-tags">
              ${story.spot ? `<span class="story-card-tag">üìç ${escapeHtml(story.spot)}</span>` : ''}
              ${story.bestConditions ? `<span class="story-card-tag">‚öì ${escapeHtml(story.bestConditions)}</span>` : ''}
            </div>
            <div class="story-card-footer">
              <div class="story-card-meta">
                ${dateLabel ? `<span>${escapeHtml(dateLabel)}</span>` : ''}
                ${story.featured ? '<span class="story-card-featured">‚≠ê Destacada</span>' : ''}
              </div>
              <button type="button" class="story-like-btn${isLiked ? ' liked' : ''}${isLoadingLike ? ' loading' : ''}" data-story-id="${story.id}" aria-pressed="${isLiked}" ${isLoadingLike ? 'disabled' : ''}>
                <span class="like-icon">‚ù§Ô∏è</span>
                <span class="like-count">${likes}</span>
              </button>
            </div>
          </div>
        `;
        card.addEventListener('click', () => openStoryModal(story.id));
        const likeButton = card.querySelector('.story-like-btn');
        likeButton?.addEventListener('click', (event) => {
          event.stopPropagation();
          const storyId = likeButton.dataset.storyId;
          if (storyId) toggleStoryLike(storyId);
        });
      storiesGrid.appendChild(card);
      });
    }

    function updateStoryEntry(updatedStory) {
      if (!updatedStory || !updatedStory.id) return;
      const index = storiesState.stories.findIndex((item) => item.id === updatedStory.id);
      if (index >= 0) {
        storiesState.stories[index] = { ...storiesState.stories[index], ...updatedStory };
      } else {
        storiesState.stories.push(updatedStory);
      }
    }

    function setStoryModalLikeState(story) {
      if (!storyModalLikeButton || !storyModalLikeCount) return;
      if (!story) {
        storyModalLikeButton.dataset.storyId = '';
        storyModalLikeButton.setAttribute('aria-pressed', 'false');
        storyModalLikeButton.classList.remove('liked', 'loading');
        storyModalLikeButton.disabled = true;
        storyModalLikeCount.textContent = '0';
        return;
      }
      const likes = Number.isFinite(story.likes) ? story.likes : 0;
      storyModalLikeCount.textContent = String(likes);
      storyModalLikeButton.dataset.storyId = story.id;
      const isLiked = Boolean(story.liked);
      storyModalLikeButton.setAttribute('aria-pressed', String(isLiked));
      storyModalLikeButton.classList.toggle('liked', isLiked);
      const isLoading = storiesState.pendingLikes.has(story.id);
      storyModalLikeButton.classList.toggle('loading', isLoading);
      storyModalLikeButton.disabled = isLoading;
    }

    async function toggleStoryLike(storyId) {
      if (!storyId || storiesState.pendingLikes.has(storyId)) return;
      const authState = window.supAuth && typeof window.supAuth.getState === 'function' ? window.supAuth.getState() : null;
      const token = authState?.token;
      if (!token) {
        window.supAuth?.openAuthModal?.();
        return;
      }
      storiesState.pendingLikes.add(storyId);
      renderStories(storiesState.stories);
      if (currentModalStoryId === storyId) {
        const modalStory = storiesState.stories.find((item) => item.id === storyId);
        if (modalStory) setStoryModalLikeState({ ...modalStory, liked: modalStory.liked, likes: modalStory.likes });
      }
      try {
        const response = await fetch(`${STORIES_API_BASE}/v1/stories/${storyId}/like`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
        });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        if (data.story) {
          updateStoryEntry(data.story);
          if (currentModalStoryId === storyId) {
            setStoryModalLikeState(data.story);
          }
        }
      } catch (error) {
        console.error('Error al registrar me gusta', error);
      } finally {
        storiesState.pendingLikes.delete(storyId);
        renderStories(storiesState.stories);
        if (currentModalStoryId === storyId) {
          const modalStory = storiesState.stories.find((item) => item.id === storyId);
          if (modalStory) setStoryModalLikeState(modalStory);
        }
      }
    }

    function openStoryCreateModal() {
      const authState = window.supAuth && typeof window.supAuth.getState === 'function' ? window.supAuth.getState() : null;
      const token = authState?.token;
      if (!token) {
        window.supAuth?.openAuthModal?.();
        return;
      }
      if (storyCreateModal) {
        storyCreateModal.style.display = 'flex';
      }
    }

    function closeStoryCreateModal() {
      if (storyCreateModal) {
        storyCreateModal.style.display = 'none';
      }
    }

    function openStoryModal(storyId) {
      if (!storyModal) return;
      const story = storiesState.stories.find((item) => item.id === storyId);
      if (!story) return;
      currentModalStoryId = story.id;
      if (storyModalMedia) {
        storyModalMedia.innerHTML = '';
        const mediaUrl = safeMediaUrl(story.mediaUrl);
        if (mediaUrl) {
          const img = document.createElement('img');
          img.src = mediaUrl;
          img.alt = `Historia de ${story.authorName || 'la comunidad SUP'}`;
          img.loading = 'lazy';
          storyModalMedia.appendChild(img);
          storyModalMedia.style.display = 'block';
          storyModalMedia.setAttribute('aria-hidden', 'false');
        } else {
          storyModalMedia.style.display = 'none';
          storyModalMedia.setAttribute('aria-hidden', 'true');
        }
      }
      if (storyModalTitle) storyModalTitle.textContent = story.title || 'Historia SUP';
      if (storyModalAuthor) storyModalAuthor.textContent = story.authorName
        ? `Por ${story.authorName}`
        : 'Historia de la comunidad SUP';
      if (storyModalText) storyModalText.textContent = story.body || '';
      if (storyModalFeatured) {
        storyModalFeatured.style.display = story.featured ? 'inline-flex' : 'none';
      }
      if (storyModalMeta) {
        const bits = [];
        if (story.spot) bits.push(`üìç ${story.spot}`);
        if (story.bestConditions) bits.push(`‚öì ${story.bestConditions}`);
        const dateLabel = formatStoryDate(story.publishedAt || story.updatedAt || story.createdAt);
        if (dateLabel) bits.push(`üóì ${dateLabel}`);
        storyModalMeta.innerHTML = bits.map((bit) => `<span>${escapeHtml(bit)}</span>`).join('');
        storyModalMeta.style.display = bits.length ? 'flex' : 'none';
      }
      setStoryModalLikeState(story);
      storyModal.style.display = 'flex';
    }

    function closeStoryModal() {
      if (!storyModal) return;
      storyModal.style.display = 'none';
      currentModalStoryId = null;
      setStoryModalLikeState(null);
    }

    function setStoriesLoading(isLoading) {
      storiesState.loading = isLoading;
      if (storiesRefreshButton) {
        storiesRefreshButton.disabled = isLoading;
        storiesRefreshButton.textContent = isLoading ? '‚è≥ Cargando‚Ä¶' : 'üîÑ Actualizar';
      }
      if (isLoading && storiesEmpty) {
        storiesEmpty.style.display = 'block';
        storiesEmpty.innerHTML = '<p>‚è≥ Cargando historias‚Ä¶</p>';
      }
    }

    function loadStories(force = false) {
      if (!storiesGrid || storiesState.loading) return;
      setStoriesLoading(true);
      const url = new URL(`${STORIES_API_BASE}/v1/stories`);
      if (force) {
        url.searchParams.set('cb', String(Date.now()));
      }
      const authState = window.supAuth && typeof window.supAuth.getState === 'function' ? window.supAuth.getState() : null;
      const headers = {};
      if (authState?.token) {
        headers.Authorization = `Bearer ${authState.token}`;
      }
      fetch(url.toString(), { cache: 'no-store', headers })
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          return response.json();
        })
        .then((data) => {
          storiesState.stories = Array.isArray(data.stories) ? data.stories : [];
          renderStories(storiesState.stories);
        })
        .catch((error) => {
          console.error('Error cargando historias', error);
          if (storiesEmpty) {
            storiesEmpty.style.display = 'block';
            storiesEmpty.innerHTML = '<p>‚ö†Ô∏è No pudimos cargar las historias. Intenta nuevamente m√°s tarde.</p>';
          }
        })
        .finally(() => {
          setStoriesLoading(false);
        });
    }

    storiesRefreshButton?.addEventListener('click', () => loadStories(true));
    window.addEventListener('sup-auth-changed', () => loadStories(true));
    storyCreateButtons.forEach((button) => {
      button.addEventListener('click', (event) => {
        event.preventDefault();
        openStoryCreateModal();
      });
    });
    storyCreateCloseButton?.addEventListener('click', (event) => {
      event.preventDefault();
      closeStoryCreateModal();
    });
    storyModalClose?.addEventListener('click', closeStoryModal);
    storyModalLikeButton?.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      const storyId = storyModalLikeButton.dataset.storyId;
      if (storyId) toggleStoryLike(storyId);
    });
    storyModal?.addEventListener('click', (event) => {
      if (event.target === storyModal) {
        closeStoryModal();
      }
    });
    storyCreateModal?.addEventListener('click', (event) => {
      if (event.target === storyCreateModal) {
        closeStoryCreateModal();
      }
    });
    window.addEventListener('story-saved', closeStoryCreateModal);

    if (localStorage.getItem("modoOscuro") === "true") {
      document.body.classList.add("oscuro");
    }

    function verCondicionesActuales() {
      if (!pronostico) return;

      const ahora = new Date();
      const horaActual = ahora.getHours();
      const bloques = pronostico && Array.isArray(pronostico.hoy) ? pronostico.hoy : [];
      if (!bloques.length) return;

      let bloqueActual = bloques.find(b => {
        const h = parseInt(b.hora.split(":")[0], 10);
        return h >= horaActual;
      });

      if (!bloqueActual) bloqueActual = bloques[bloques.length - 1];
      const nivelClass = bloqueActual.nivel.toLowerCase();

      const modal = document.getElementById("modal-actual");
      const contenido = document.getElementById("modal-contenido");

      contenido.innerHTML = `
        <button onclick="cerrarModal()" class="cerrar-modal">‚úï</button>
        <h3 class="modal-title">Ahora (aprox ${bloqueActual.hora} hrs)</h3>
        <span class="nivel-pill ${nivelClass}">${bloqueActual.nivel}</span>
        <div class="modal-metrics">
          <div class="metric">
            <span class="label">Viento</span>
            <span class="value">${bloqueActual.viento}</span>
            <span class="hint">${bloqueActual.direccionViento}</span>
          </div>
          <div class="metric">
            <span class="label">Oleaje</span>
            <span class="value">${bloqueActual.oleaje}</span>
            <span class="hint">${bloqueActual.direccionOleaje}</span>
          </div>
          <div class="metric">
            <span class="label">Temperatura del agua</span>
            <span class="value">${bloqueActual.temperatura}</span>
          </div>
        </div>
        <p class="modal-condiciones">${bloqueActual.condiciones}</p>
      `;

      modal.style.display = "flex";
    }

    function cerrarModal() {
      const modal = document.getElementById("modal-actual");
      if (modal) modal.style.display = "none";
    }

    const modalOverlay = document.getElementById("modal-actual");
    if (modalOverlay) {
      modalOverlay.addEventListener("click", event => {
        if (event.target === modalOverlay) {
          cerrarModal();
        }
      });
    }

    document.addEventListener("keydown", event => {
      if (event.key === "Escape") {
        cerrarModal();
        closeStoryModal();
      }
    });

    loadStories();

    fetch(`data.json?cb=${Date.now()}`, { cache: "no-store" })
      .then(res => res.json())
      .then(data => {
        pronostico = data;
        const fechaBase = new Date();
        actualizarFechaVisor(fechaBase, "Hoy");

        renderizarPronostico("hoy");

        if (data.generado) {
          const generado = document.getElementById("generado-el");
          if (generado) {
            generado.innerHTML = `<strong>üïí Datos generados:</strong> ${data.generado}`;
          }
        }

        mostrarHorariosMarea(data);
      })
      .catch(err => {
        console.error("Error cargando data.json", err);
      });
  </script>
  <script type="module" src="auth.js"></script>
</body>
</html>
