<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SUP Status - La Herradura</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="styles.css">
  <script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations?.().then((regs) => {
        regs.forEach((reg) => reg.unregister());
      });
    }
  </script>
</head>
<body id="top">
  <header class="top-bar container">
    <div class="top-actions">
      <button type="button" class="top-avatar-trigger" id="profile-link" aria-label="Abrir perfil">
        <img id="auth-header-avatar" class="top-avatar" src="logosupstatus.png" alt="Avatar SUP" />
        <span class="top-avatar-label">Mi perfil</span>
      </button>
      <button class="session-global-button" id="session-global-open">🚀 Registrar remada</button>
      <button class="ghost story-create-trigger" data-story-open>✨ Compartir historia</button>
      <button class="ghost" id="auth-button">🔐 Iniciar sesión</button>
    </div>
  </header>

  <main class="layout">
    <section class="stories-section container" id="stories-section">
      <div class="stories-wrapper">
        <div class="stories-header">
          <div class="stories-heading">
            <span class="stories-title">Historias SUP</span>
            <span class="stories-subtitle">Momentos recientes de la comunidad.</span>
          </div>
        </div>
        <div class="stories-rail-container">
          <div class="stories-empty" id="stories-empty" style="display: block;">
            <p>📘 Aún no hay historias destacadas. ¡Comparte la tuya desde tu perfil!</p>
          </div>
          <div class="stories-rail" id="stories-rail" role="list"></div>
        </div>
      </div>
    </section>

    <section class="hero container">
      <div class="hero-copy">
        <img src="Logos/SUP_Experience_Variables(horizontal)_Hor_Base.png" alt="SUP Status logo" class="hero-logo">
        <span class="hero-tagline">Condiciones para tu remada</span>
        <p class="subtitle">Condiciones confiables, mareas y ventanas ideales para remar con tranquilidad en La Herradura.</p>
        <div class="hero-actions">
          <button class="primary" onclick="verCondicionesActuales()">⏱️ ¿Puedo remar ahora?</button>
          <button class="ghost" onclick="compartirInfo()">📤 Compartir reporte</button>
        </div>
        <span id="auth-greeting" class="hero-greeting">🌊 Conecta tu perfil SUP y guarda tus remadas favoritas</span>
      </div>
      <div class="hero-card" id="estado-actual">
        <div class="hero-card-header">
          <span class="hero-card-eyebrow">Siguiente ventana ideal</span>
          <span class="hero-card-chip" id="estado-nivel">—</span>
        </div>
        <h3 id="estado-hora">--:-- hrs</h3>
        <p id="estado-detalle">Esperando pronóstico…</p>
        <div class="hero-card-metrics">
          <span id="estado-viento">🌬️ --</span>
          <span id="estado-oleaje">🌊 --</span>
        </div>
      </div>
    </section>

    <section class="info-band container">
      <div id="fecha" class="info-chip">📅 Cargando fecha…</div>
      <div id="horarios-sol" class="info-chip">🌅 Calculando sol…</div>
      <div id="generado-el" class="info-chip">🕒 Actualizando datos…</div>
    </section>

    <section class="forecast container">
      <div class="forecast-header">
        <h2 class="section-title">Pronóstico por bloque · La Herradura</h2>
        <div class="forecast-controls">
          <div id="selector-dia" class="segmented">
            <button data-dia="hoy" class="activo" onclick="cambiarDia('hoy')">Hoy</button>
            <button data-dia="mañana" onclick="cambiarDia('mañana')">Mañana</button>
          </div>
          <button class="ghost" onclick="alternarModo()">🌓 Modo oscuro</button>
        </div>
      </div>
      <div class="cards-grid" id="pronostico"></div>
    </section>

    <section class="insights container">
      <div class="insights-card">
        <h2>Mareas próximas</h2>
        <p class="insights-subtitle">Mantén a la vista los próximos eventos de marea para ajustar tu salida.</p>
        <div id="horarios-marea" class="marea-chips">Cargando mareas…</div>
      </div>
      <div class="insights-card">
        <h2>Consejo rápido</h2>
        <p class="insights-tip">⚠️ Usa chaleco salvavidas, verifica el spot en terreno y navega de forma responsable. Revisa siempre las condiciones al llegar.</p>
      </div>
    </section>

    <section class="session-section container" id="session-section">
      <div class="session-wrapper">
        <div class="session-header">
          <div>
            <h2 class="section-title">Mis remadas</h2>
            <p class="session-rank" id="session-rank">Sin remadas registradas.</p>
          </div>
          <button type="button" class="ghost session-open" id="session-open-modal">➕ Registrar remada</button>
        </div>
        <div class="session-metrics" id="session-metrics">0 km · 0 sesiones · 0 h</div>
        <div class="session-list" id="session-list"></div>
        <p class="session-status" id="session-status"></p>
      </div>
    </section>

  </main>

  <footer class="container">
    <div class="footer-panel">
      <p class="creditos">Hecho con ❤️ por <a href="https://instagram.com/__jokerguzman" target="_blank" rel="noopener">@__jokerguzman</a></p>
      <div class="support-row">
        <span class="support-copy">¿Te gusta el proyecto?</span>
        <a class="bmc-button" href="https://buymeacoffee.com/jokerguzman" target="_blank" rel="noopener" aria-label="Invítanos un café en Buy Me a Coffee">
          ☕ <span>Invítanos un café</span>
        </a>
      </div>
    </div>
  </footer>

  <div id="auth-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content auth-modal">
      <button type="button" class="cerrar-modal" onclick="window.closeAuthModal()">✕</button>
      <h3 class="modal-title">Inicia sesión</h3>
      <p class="modal-copy">Guarda tus sesiones y personaliza tu experiencia SUP.</p>
      <div class="auth-options">
        <button type="button" class="primary" id="google-login-btn">✨ Continuar con Google</button>
        <div class="auth-divider">
          <span></span>
          <em>o con email</em>
          <span></span>
        </div>
        <label class="auth-input">
          Email
          <input type="email" id="email-input" placeholder="tu@correo.com">
        </label>
        <label class="auth-input">
          Contraseña
          <input type="password" id="password-input" placeholder="mínimo 6 caracteres">
        </label>
        <button type="button" class="ghost" id="email-login-btn">Ingresar / Crear cuenta</button>
        <button type="button" class="ghost" id="reset-password-btn">¿Olvidaste tu contraseña?</button>
        <p class="auth-hint">Te enviaremos correos de verificación y recuperación cuando sea necesario.</p>
        <p class="auth-error" id="auth-error"></p>
      </div>
    </div>
  </div>

  <div id="profile-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content profile-modal">
      <button type="button" class="cerrar-modal" onclick="window.closeProfileModal()">✕</button>
      <h3 class="modal-title">Mi perfil</h3>
      <p class="profile-email" id="profile-email"></p>
      <div class="profile-avatar">
        <img id="profile-avatar-preview" src="logosupstatus.png" alt="Avatar SUP" class="profile-avatar-img">
        <label class="profile-avatar-upload">
          <input type="file" id="profile-avatar-input" accept="image/*">
          <span>Subir foto de perfil</span>
        </label>
        <span class="profile-avatar-status" id="profile-avatar-status"></span>
      </div>
      <div class="profile-form">
        <label>
          Nombre para mostrar
          <input id="profile-displayName" type="text" placeholder="Tu nombre o apodo">
        </label>
        <label>
          Nivel de experiencia
          <select id="profile-experienceLevel">
            <option value="">Selecciona tu nivel</option>
            <option value="Inicio reciente">Inicio reciente</option>
            <option value="Intermedio · sesiones regulares">Intermedio · sesiones regulares</option>
            <option value="Avanzado · largas distancias">Avanzado · largas distancias</option>
            <option value="Competencia / instructor">Competencia / instructor</option>
          </select>
        </label>
        <label>
          Modalidad favorita
          <select id="profile-favoriteDiscipline">
            <option value="">¿Qué te motiva más?</option>
            <option value="Placer / recreacional">Placer / recreacional</option>
            <option value="Racing / resistencia">Racing / resistencia</option>
            <option value="Downwind / mar abierto">Downwind / mar abierto</option>
            <option value="SUP surf">SUP surf</option>
            <option value="SUP yoga / fitness">SUP yoga / fitness</option>
            <option value="Exploración / travesías">Exploración / travesías</option>
          </select>
        </label>
        <label>
          Equipo principal
          <input id="profile-boardSetup" type="text" placeholder="Tabla, remo u otros detalles clave">
        </label>
        <label>
          Bio
          <textarea id="profile-bio" rows="3" placeholder="Comparte un poco sobre tu experiencia SUP"></textarea>
        </label>
        <label>
          Objetivo actual en el SUP
          <textarea id="profile-goals" rows="3" placeholder="Cuéntanos qué te gustaría lograr remando"></textarea>
        </label>
        <label>
          Rutina o enfoque actual
          <textarea id="profile-practiceFocus" rows="2" placeholder="Ej: mejorar técnica de giro, preparar travesía, más equilibrio, etc."></textarea>
        </label>
      </div>
      <div class="profile-actions">
        <button class="primary" id="profile-save">Guardar perfil</button>
        <span class="profile-status" id="profile-status"></span>
      </div>
    <div class="admin-section" id="admin-section" style="display: none;">
      <h4>Perfiles registrados</h4>
      <p class="admin-hint">Solo el equipo puede ver esta vista.</p>
      <div class="admin-metrics" id="admin-metrics"></div>
      <div class="admin-list" id="admin-profile-list"></div>
    </div>
  </div>
  </div>

  <div id="modal-actual" class="modal-overlay" style="display: none;">
    <div class="modal-content" id="modal-contenido">
      <button onclick="cerrarModal()" class="cerrar-modal">✕</button>
    </div>
  </div>

  <div id="story-create-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content story-create-modal">
      <button type="button" class="cerrar-modal" id="story-create-close">✕</button>
      <div class="story-editor">
        <div class="story-editor-header">
          <h4>Comparte tu momento SUP</h4>
          <p>Cuenta cómo estuvo tu sesión, agrega una foto y un spot cercano.</p>
        </div>
        <label class="story-editor-comment">
          Comentario
          <textarea id="story-body" rows="4" placeholder="¿Cómo estuvo tu remada hoy?"></textarea>
        </label>
        <div class="story-location">
          <div class="story-location-actions">
            <button class="ghost story-location-btn" type="button" id="story-location-button">📍 Obtener sugerencias cercanas</button>
            <button class="ghost story-location-clear" type="button" id="story-location-clear" style="display: none;">✕ Quitar sugerencia</button>
          </div>
          <span class="story-location-status" id="story-location-status"></span>
          <div class="story-location-suggestions" id="story-location-suggestions"></div>
        </div>
        <div class="story-editor-media">
          <div class="story-media-controls">
            <label class="story-media-upload">
              <input type="file" id="story-media-input" accept="image/*">
              <span>📷 Subir foto (opcional)</span>
            </label>
            <button class="ghost story-media-remove" type="button" id="story-media-remove" disabled>Quitar foto</button>
          </div>
          <div class="story-media-preview-wrapper" id="story-media-preview-wrapper" style="display: none;">
            <img id="story-media-preview" class="story-media-preview" src="" alt="Vista previa de la historia">
          </div>
          <span class="story-media-status" id="story-media-status"></span>
        </div>
        <div class="story-editor-actions">
          <button class="ghost" type="button" id="story-reset">Restablecer</button>
          <button class="primary" type="button" id="story-save">Compartir historia</button>
          <span class="story-editor-status" id="story-status"></span>
        </div>
        <p class="story-editor-meta" id="story-meta"></p>
        <div class="story-history">
          <div class="story-history-header">
            <h5>Mis historias</h5>
            <span class="story-history-count" id="user-story-count">0</span>
          </div>
          <div class="story-history-list" id="user-story-list"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="story-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content story-modal">
      <button type="button" class="cerrar-modal" id="story-modal-close">✕</button>
      <div class="story-modal-track" id="story-modal-track" aria-hidden="true"></div>
      <div class="story-modal-shell">
        <button type="button" class="story-modal-nav story-modal-nav--prev" id="story-modal-prev" aria-label="Historia anterior">‹</button>
        <div class="story-modal-body">
          <div class="story-modal-media" id="story-modal-media" aria-hidden="true"></div>
          <div class="story-modal-copy">
            <div class="story-modal-header">
              <div class="story-modal-author-chip">
                <div class="story-modal-avatar" id="story-modal-avatar" aria-hidden="true"></div>
                <div class="story-modal-author-text">
                  <p class="story-modal-author" id="story-modal-author"></p>
                  <p class="story-modal-author-meta" id="story-modal-author-meta"></p>
                </div>
              </div>
              <span class="story-modal-tag" id="story-modal-featured" style="display: none;">⭐ Destacada</span>
            </div>
            <h3 id="story-modal-title"></h3>
            <div class="story-modal-meta" id="story-modal-meta"></div>
            <div class="story-modal-actions">
              <button type="button" class="story-like-btn" id="story-modal-like-btn" aria-pressed="false">
                <span class="like-icon">❤️</span>
                <span class="like-count" id="story-modal-like-count">0</span>
              </button>
              <button type="button" class="story-modal-delete-btn" id="story-modal-delete-btn" style="display: none;">🗑 Eliminar</button>
            </div>
            <p class="story-modal-text" id="story-modal-text"></p>
          </div>
        </div>
        <button type="button" class="story-modal-nav story-modal-nav--next" id="story-modal-next" aria-label="Siguiente historia">›</button>
      </div>
    </div>
  </div>

  <div id="session-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content session-modal">
      <button type="button" class="cerrar-modal" id="session-modal-close">✕</button>
      <h4 class="modal-title">Registrar remada</h4>
      <p class="session-modal-hint">Registra tus remadas manualmente o inicia un seguimiento en vivo desde tu teléfono.</p>
      <div class="session-tabs">
        <button type="button" data-session-tab="tracking" class="active">📍 Seguimiento</button>
        <button type="button" data-session-tab="manual">📝 Registro manual</button>
      </div>
      <div class="session-panel" data-session-panel="tracking">
        <div class="session-tracking-indicator" id="session-tracking-status">Listo para iniciar seguimiento.</div>
        <div class="session-tracking-metrics">
          <div>
            <span class="label">Distancia</span>
            <span class="value" id="session-tracking-distance">0.00 km</span>
          </div>
          <div>
            <span class="label">Duración</span>
            <span class="value" id="session-tracking-duration">00:00:00</span>
          </div>
          <div>
            <span class="label">Puntos</span>
            <span class="value" id="session-tracking-points">0</span>
          </div>
        </div>
        <div class="session-tracking-actions">
          <button type="button" class="primary" id="session-tracking-start">▶️ Iniciar seguimiento</button>
          <button type="button" class="ghost" id="session-tracking-stop" disabled>⏹ Detener</button>
          <button type="button" class="ghost" id="session-tracking-reset" disabled>↺ Reiniciar</button>
        </div>
        <p class="session-tracking-hint">Mantén el teléfono seguro sobre la tabla. El seguimiento usa tu GPS para estimar distancia y tiempo.</p>
      </div>
      <div class="session-panel" data-session-panel="manual" style="display: none;">
        <label>
          Fecha y hora de inicio
          <input type="datetime-local" id="session-start">
        </label>
        <label>
          Spot o lugar
          <input type="text" id="session-spot" placeholder="Ej: Bahía tranquila, Lago X">
        </label>
        <div class="session-form-row">
          <label>
            Distancia (km)
            <input type="number" id="session-distance" min="0" step="0.01" placeholder="Ej: 4.5">
          </label>
          <label>
            Duración (min)
            <input type="number" id="session-duration" min="0" step="1" placeholder="Ej: 75">
          </label>
        </div>
        <label>
          Notas
          <textarea id="session-notes" rows="3" placeholder="Condiciones, sensaciones, equipo, etc."></textarea>
        </label>
      </div>
      <div class="session-modal-footer">
        <button type="button" class="ghost" id="session-reset">Cancelar</button>
        <button type="button" class="primary" id="session-save">Guardar remada</button>
      </div>
      <p class="session-modal-status" id="session-modal-status"></p>
    </div>
  </div>

  <div id="session-detail-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content session-detail-modal">
      <button type="button" class="cerrar-modal" id="session-detail-close">✕</button>
      <h4 class="modal-title" id="session-detail-title">Detalle de la remada</h4>
      <div class="session-detail-summary" id="session-detail-summary"></div>
      <div class="session-detail-map-wrapper">
        <canvas id="session-detail-canvas" width="360" height="240"></canvas>
        <p class="session-detail-map-hint" id="session-detail-map-hint"></p>
      </div>
      <p class="session-detail-notes" id="session-detail-notes"></p>
      <div class="session-detail-actions">
        <button type="button" class="ghost" id="session-detail-share">Compartir como historia</button>
        <button type="button" class="ghost session-detail-delete" id="session-detail-delete">🗑 Eliminar remada</button>
      </div>
      <p class="session-detail-status" id="session-detail-status"></p>
    </div>
  </div>

  <button type="button" class="story-create-fab" data-story-open aria-label="Compartir historia">✨ Compartir</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let pronostico;
    let diaActual = "hoy";
    let miniMaps = [];
    const estadoHoraEl = document.getElementById('estado-hora');
    const estadoNivelEl = document.getElementById('estado-nivel');
    const estadoDetalleEl = document.getElementById('estado-detalle');
    const estadoVientoEl = document.getElementById('estado-viento');
    const estadoOleajeEl = document.getElementById('estado-oleaje');

    const lat = -29.983059;
    const lon = -71.365225;
    function initializeMiniMap(mapId, direccionGrados) {
      const container = document.getElementById(mapId);
      if (!container || Number.isNaN(direccionGrados)) return;
      const miniMap = L.map(container, {
        attributionControl: false,
        zoomControl: false,
        dragging: false,
        scrollWheelZoom: false,
        doubleClickZoom: false,
        boxZoom: false,
        keyboard: false,
        tap: false,
      }).setView([lat, lon], 15);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
      }).addTo(miniMap);
      const iconoMini = L.divIcon({
        className: 'mini-wind-marker',
        html: `<div class="mini-wind-arrow" style="transform: rotate(${direccionGrados}deg);"></div>`,
      });
      L.marker([lat, lon], { icon: iconoMini }).addTo(miniMap);
      miniMaps.push(miniMap);
      setTimeout(() => miniMap.invalidateSize(), 120);
    }

    function actualizarFechaVisor(fecha, etiqueta) {
      const fechaElemento = document.getElementById("fecha");
      if (!fechaElemento) return;
      const formatoFecha = fecha.toLocaleDateString('es-CL', { weekday: 'long', day: 'numeric', month: 'long' });
      const capitalizada = formatoFecha.charAt(0).toUpperCase() + formatoFecha.slice(1);
      fechaElemento.innerHTML = `<strong>📅 ${etiqueta}:</strong> ${capitalizada}`;
    }

    function cleanupMiniMaps() {
      miniMaps.forEach((mapInstance) => {
        try {
          mapInstance.remove();
        } catch (_error) {}
      });
      miniMaps = [];
    }

    function getFeaturedIndex(blocks, dia) {
      if (!Array.isArray(blocks) || !blocks.length) return 0;
      if (dia !== 'hoy') return 0;
      const now = new Date();
      const currentHour = now.getHours();
      let index = blocks.findIndex((item) => {
        const hour = Number.parseInt((item.hora || '').split(':')[0], 10);
        return !Number.isNaN(hour) && hour >= currentHour;
      });
      if (index === -1) index = blocks.length - 1;
      return Math.max(index, 0);
    }

    function actualizarEstadoActualCard(item) {
      if (!item || !estadoHoraEl) return;
      estadoHoraEl.textContent = `${item.hora || '--:--'} hrs`;
      if (estadoNivelEl) estadoNivelEl.textContent = item.nivel || '—';
      if (estadoDetalleEl) estadoDetalleEl.textContent = item.condiciones || 'Mantente atento a las actualizaciones.';
      if (estadoVientoEl) estadoVientoEl.textContent = `🌬️ ${item.viento || '--'}`;
      if (estadoOleajeEl) estadoOleajeEl.textContent = `🌊 ${item.oleaje || '--'}`;
    }

    function renderizarPronostico(dia) {
      if (!pronostico || !pronostico[dia]) return;
      diaActual = dia;

      document.querySelectorAll('#selector-dia button').forEach(btn => {
        const activo = btn.dataset.dia === dia;
        btn.classList.toggle('activo', activo);
      });

      const hoy = new Date();
      const fecha = new Date(hoy);
      if (dia === "mañana") {
        fecha.setDate(hoy.getDate() + 1);
      }
      actualizarFechaVisor(fecha, dia === "mañana" ? "Mañana" : "Hoy");
      mostrarHorariosSol(fecha);

      const contenedor = document.getElementById("pronostico");
      if (!contenedor) return;
      contenedor.innerHTML = "";

      cleanupMiniMaps();

      const bloques = pronostico[dia];
      const highlightedIndex = getFeaturedIndex(bloques, dia);

      bloques.forEach((item, i) => {
        const card = document.createElement("article");
        card.className = "card";

        if (i === highlightedIndex) {
          card.classList.add('featured');
        }

        card.style.animationDelay = `${i * 0.08}s`;

        const nivelClass = item.nivel.toLowerCase();
        const mapId = `mini-map-${dia}-${i}`;

        card.innerHTML = `
          <div class="card-header">
            <span class="hora">${item.hora} hrs</span>
            <span class="nivel-pill ${nivelClass}">${item.nivel}</span>
          </div>
          <div class="metrics">
            <div class="metric">
              <span class="label">Viento</span>
              <span class="value">${item.viento}</span>
              <span class="hint">${item.direccionViento}</span>
            </div>
            <div class="metric">
              <span class="label">Oleaje</span>
              <span class="value">${item.oleaje}</span>
              <span class="hint">${item.direccionOleaje}</span>
            </div>
            <div class="metric">
              <span class="label">Temperatura del agua</span>
              <span class="value">${item.temperatura}</span>
            </div>
          </div>
          <div class="card-map">
            <div class="card-map-header">
              <span>Dirección del viento</span>
            </div>
            <div class="mini-map" id="${mapId}" aria-hidden="true"></div>
            <span class="mini-map-note">Viento: ${item.direccionViento}</span>
          </div>
          <p class="condiciones">${item.condiciones}</p>
        `;

        contenedor.appendChild(card);
        initializeMiniMap(mapId, Number.parseInt(item.direccionVientoGrados, 10));
      });

      actualizarEstadoActualCard(bloques[highlightedIndex]);
    }

    function cambiarDia(valor) {
      renderizarPronostico(valor);
    }

    function alternarModo() {
      document.body.classList.toggle("oscuro");
      localStorage.setItem("modoOscuro", document.body.classList.contains("oscuro"));
    }

    function compartirInfo() {
      const texto = 'Revisa las condiciones en SUP Status - La Herradura: ' + window.location.href;
      if (navigator.share) {
        navigator.share({ title: 'SUP Status - La Herradura', text: texto, url: window.location.href });
      } else {
        alert("Tu navegador no soporta la función de compartir.");
      }
    }

    function mostrarHorariosSol(fechaBase) {
      const solContainer = document.getElementById("horarios-sol");
      if (!solContainer) return;
      const { sunrise, sunset } = SunCalc.getTimes(fechaBase, lat, lon);
      const formatoHora = hora => hora.toLocaleTimeString('es-CL', { hour: '2-digit', minute: '2-digit' });
      solContainer.innerHTML = `<strong>🌅 Sol:</strong> ${formatoHora(sunrise)} · ${formatoHora(sunset)}`;
    }

    function normalizarTipoMarea(tipo) {
      if (!tipo) return '';
      const normalized = tipo.toString().trim().toLowerCase();
      if (normalized.includes('alta')) return 'alta';
      if (normalized.includes('subiendo')) return 'subiendo';
      if (normalized.includes('baja')) return 'baja';
      if (normalized.includes('bajando')) return 'bajando';
      if (normalized.includes('media')) return 'media';
      return normalized || '';
    }

    function mostrarHorariosMarea(data) {
      const mareaContainer = document.getElementById("horarios-marea");
      if (!mareaContainer) return;
      let listado = Array.isArray(data.mareas) ? data.mareas : [];

      if (!listado.length) {
        const pronosticos = []
          .concat(Array.isArray(data.hoy) ? data.hoy : [])
          .concat(Array.isArray(data["mañana"]) ? data["mañana"] : []);
        listado = pronosticos
          .filter((item) => item && item.marea && item.hora)
          .map((item) => ({
            tipo: normalizarTipoMarea(item.marea),
            hora: item.hora,
            origen: 'pronostico',
          }));
      }

      const iconos = { alta: "🌊⬆️", baja: "🌊⬇️", subiendo: "🌊↗️", bajando: "🌊↘️", media: "🌊" };
      const chips = listado
        .filter((m) => m && m.tipo && m.hora)
        .slice(0, 6)
        .map((m) => `<span class="marea-pill">${iconos[m.tipo] || "🌊"} ${m.tipo} ${m.hora}</span>`)
        .join("");

      if (chips) {
        mareaContainer.innerHTML = chips;
      } else {
        mareaContainer.innerHTML = `<span class="marea-pill marea-pill--empty">🌀 Sin mareas disponibles</span>`;
      }
    }

    const STORIES_API_BASE = window.location.hostname === 'localhost'
      ? 'http://localhost:8080'
      : 'https://sup-experience-backend-mhhf2ac76q-ue.a.run.app';
    const storiesState = { stories: [], loading: false, pendingLikes: new Set() };
    const storiesRail = document.getElementById('stories-rail');
    const storiesEmpty = document.getElementById('stories-empty');
    const storiesActivityLabel = document.getElementById('stories-activity');
    const storyModal = document.getElementById('story-modal');
    const storyModalClose = document.getElementById('story-modal-close');
    const storyModalPrevButton = document.getElementById('story-modal-prev');
    const storyModalNextButton = document.getElementById('story-modal-next');
    const storyModalTrack = document.getElementById('story-modal-track');
    const storyModalAvatar = document.getElementById('story-modal-avatar');
    const storyCreateModal = document.getElementById('story-create-modal');
    const storyCreateButtons = Array.from(document.querySelectorAll('[data-story-open]'));
    const storyCreateCloseButton = document.getElementById('story-create-close');
    const storyModalMedia = document.getElementById('story-modal-media');
    const storyModalTitle = document.getElementById('story-modal-title');
    const storyModalAuthor = document.getElementById('story-modal-author');
    const storyModalAuthorMeta = document.getElementById('story-modal-author-meta');
    const storyModalMeta = document.getElementById('story-modal-meta');
    const storyModalText = document.getElementById('story-modal-text');
    const storyModalFeatured = document.getElementById('story-modal-featured');
    const storyModalLikeButton = document.getElementById('story-modal-like-btn');
    const storyModalLikeCount = document.getElementById('story-modal-like-count');
    const storyModalDeleteButton = document.getElementById('story-modal-delete-btn');
    const storyModalBody = document.querySelector('#story-modal .story-modal-body');
    let currentModalStoryId = null;
    let currentModalStoryData = null;
    let currentModalStoryIndex = -1;
    let storyModalTrackBars = [];
    let storyAutoAdvanceFrame = null;
    let storyAutoAdvanceStart = 0;
    let storyAutoAdvanceProgress = 0;
    let storyAutoAdvancePaused = false;
    let storiesRefreshInterval = null;
    const STORY_AUTO_ADVANCE_MS = 8000;
    const STORIES_REFRESH_INTERVAL_MS = 10000;

    function escapeHtml(value = '') {
      return value
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatStoryDate(isoString) {
      if (!isoString) return '';
      const date = new Date(isoString);
      if (Number.isNaN(date.getTime())) return '';
      return date.toLocaleDateString('es-CL', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function buildExcerpt(text = '', maxLength = 160) {
      const trimmed = text.trim();
      if (!trimmed) return '';
      if (trimmed.length <= maxLength) return trimmed;
      const slice = trimmed.slice(0, maxLength);
      return `${slice.replace(/\s+\S*$/, '')}…`;
    }

    function safeMediaUrl(value) {
      if (typeof value !== 'string') return '';
      const url = value.trim();
      if (/^https?:\/\//i.test(url)) return url;
      if (/^data:image\/[a-zA-Z]+;base64,/i.test(url)) return url;
      return url;
    }

    function storyTimestamp(story) {
      const source = story.publishedAt || story.updatedAt || story.createdAt;
      if (!source) return 0;
      const date = new Date(source);
      return Number.isNaN(date.getTime()) ? 0 : date.getTime();
    }

    function getSortedStories() {
      const stories = Array.isArray(storiesState.stories) ? storiesState.stories : [];
      return [...stories].sort((a, b) => {
        if (Boolean(a.featured) !== Boolean(b.featured)) {
          return b.featured ? 1 : -1;
        }
        return storyTimestamp(b) - storyTimestamp(a);
      });
    }

    function getStoryDisplayName(story) {
      if (!story) return 'Remador SUP';
      if (typeof story.authorName === 'string' && story.authorName.trim().length) {
        return story.authorName.trim();
      }
      if (typeof story.authorEmail === 'string' && story.authorEmail.includes('@')) {
        return story.authorEmail.split('@')[0];
      }
      return 'Remador SUP';
    }

    function getStoryInitials(name) {
      if (typeof name !== 'string' || !name.trim()) return 'SUP';
      const parts = name.trim().split(/\s+/).filter(Boolean);
      if (!parts.length) return 'SUP';
      const first = parts[0][0] || '';
      const second = parts.length > 1 ? parts[1][0] || '' : '';
      const letters = `${first}${second}`.trim();
      return letters ? letters.toUpperCase() : (first || 'S').toUpperCase();
    }

    function getStoryAvatarUrl(story) {
      if (!story || typeof story !== 'object') return '';
      const candidates = [
        story.authorAvatarUrl,
        story.authorAvatar,
        story.avatarUrl,
        story.authorPhotoUrl,
        story.authorPhoto,
        story.authorImageUrl,
        story.mediaAvatarUrl,
        story.mediaUrl,
      ];
      const value = candidates.find((item) => typeof item === 'string' && item.trim().length);
      return value ? safeMediaUrl(value.trim()) : '';
    }

    function renderStories(stories) {
      if (!storiesRail) return;
      storiesRail.innerHTML = '';
      if (!stories || !stories.length) {
        if (storiesEmpty) {
          storiesEmpty.style.display = 'block';
          storiesEmpty.innerHTML = '<p>📘 Aún no hay historias destacadas. ¡Comparte la tuya desde tu perfil!</p>';
        }
        return;
      }
      if (storiesEmpty) storiesEmpty.style.display = 'none';
      const sorted = getSortedStories();
      sorted.forEach((story, index) => {
        const bubble = document.createElement('button');
        bubble.type = 'button';
        bubble.className = 'story-bubble';
        if (story.featured) bubble.classList.add('story-bubble--featured');
        if (story.id === currentModalStoryId) bubble.classList.add('is-active');
        const displayName = getStoryDisplayName(story);
        const avatarUrl = getStoryAvatarUrl(story);
        const initials = getStoryInitials(displayName);
        const dateLabel = formatStoryDate(story.publishedAt || story.updatedAt || story.createdAt);
        bubble.dataset.storyId = story.id || '';
        bubble.dataset.storyIndex = index >= 0 ? String(index) : '';
        bubble.setAttribute('aria-label', `Historia de ${displayName}`);
        bubble.setAttribute('role', 'listitem');
        bubble.innerHTML = `
          <span class="story-bubble-ring">
            ${avatarUrl
              ? `<img class="story-bubble-avatar" src="${escapeHtml(avatarUrl)}" alt="Avatar de ${escapeHtml(displayName)}" loading="lazy">`
              : `<span class="story-bubble-initial">${escapeHtml(initials)}</span>`}
          </span>
          <span class="story-bubble-name">${escapeHtml(displayName)}</span>
          ${story.featured ? '<span class="story-bubble-meta">⭐ Destacada</span>' : (dateLabel ? `<span class="story-bubble-meta">${escapeHtml(dateLabel)}</span>` : '')}
        `;
        bubble.addEventListener('click', () => openStoryModalByIndex(index >= 0 ? index : 0));
        storiesRail.appendChild(bubble);
      });
      updateStoryRailActiveState();
    }

    function updateStoryRailActiveState() {
      if (!storiesRail) return;
      Array.from(storiesRail.children).forEach((node) => {
        if (!(node instanceof HTMLElement)) return;
        const isActive = currentModalStoryId && node.dataset.storyId === currentModalStoryId;
        node.classList.toggle('is-active', Boolean(isActive));
        if (isActive) {
          node.setAttribute('aria-current', 'true');
        } else {
          node.removeAttribute('aria-current');
        }
      });
    }

    function updateStoryEntry(updatedStory) {
      if (!updatedStory || !updatedStory.id) return;
      const index = storiesState.stories.findIndex((item) => item.id === updatedStory.id);
      if (index >= 0) {
        storiesState.stories[index] = { ...storiesState.stories[index], ...updatedStory };
      } else {
        storiesState.stories.push(updatedStory);
      }
    }

    function setStoryModalLikeState(story) {
      if (!storyModalLikeButton || !storyModalLikeCount) return;
      if (!story) {
        storyModalLikeButton.dataset.storyId = '';
        storyModalLikeButton.setAttribute('aria-pressed', 'false');
        storyModalLikeButton.classList.remove('liked', 'loading');
        storyModalLikeButton.disabled = true;
        storyModalLikeCount.textContent = '0';
        return;
      }
      const likes = Number.isFinite(story.likes) ? story.likes : 0;
      storyModalLikeCount.textContent = String(likes);
      storyModalLikeButton.dataset.storyId = story.id;
      const isLiked = Boolean(story.liked);
      storyModalLikeButton.setAttribute('aria-pressed', String(isLiked));
      storyModalLikeButton.classList.toggle('liked', isLiked);
      const isLoading = storiesState.pendingLikes.has(story.id);
      storyModalLikeButton.classList.toggle('loading', isLoading);
      storyModalLikeButton.disabled = isLoading;
    }

    async function toggleStoryLike(storyId) {
      if (!storyId || storiesState.pendingLikes.has(storyId)) return;
      const authState = window.supAuth && typeof window.supAuth.getState === 'function' ? window.supAuth.getState() : null;
      const token = authState?.token;
      if (!token) {
        window.supAuth?.openAuthModal?.();
        return;
      }
      storiesState.pendingLikes.add(storyId);
      renderStories(storiesState.stories);
      if (currentModalStoryId === storyId) {
        const modalStory = storiesState.stories.find((item) => item.id === storyId);
        if (modalStory) setStoryModalLikeState({ ...modalStory, liked: modalStory.liked, likes: modalStory.likes });
      }
      try {
        const response = await fetch(`${STORIES_API_BASE}/v1/stories/${storyId}/like`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`,
          },
        });
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        if (data.story) {
          updateStoryEntry(data.story);
          if (currentModalStoryId === storyId) {
            setStoryModalLikeState(data.story);
          }
        }
      } catch (error) {
        console.error('Error al registrar me gusta', error);
      } finally {
        storiesState.pendingLikes.delete(storyId);
        renderStories(storiesState.stories);
        if (currentModalStoryId === storyId) {
          const modalStory = storiesState.stories.find((item) => item.id === storyId);
          if (modalStory) setStoryModalLikeState(modalStory);
        }
      }
    }

    async function deleteStoryFromModal(storyId) {
      if (!storyId || !storyModalDeleteButton) return;
      const authState = window.supAuth && typeof window.supAuth.getState === 'function' ? window.supAuth.getState() : null;
      if (!authState?.isAdmin || !authState?.token) {
        window.alert('Necesitas permisos de administrador para eliminar historias.');
        return;
      }
      const confirmed = window.confirm('¿Eliminar esta historia? Esta acción no se puede deshacer.');
      if (!confirmed) return;
      storyModalDeleteButton.disabled = true;
      storyModalDeleteButton.textContent = 'Eliminando…';
      try {
        const response = await fetch(`${STORIES_API_BASE}/v1/stories/${encodeURIComponent(storyId)}`, {
          method: 'DELETE',
          headers: {
            Authorization: `Bearer ${authState.token}`,
          },
        });
        if (!response.ok) {
          const error = await response.json().catch(() => null);
          const message = error?.error || `No se pudo eliminar la historia (HTTP ${response.status}).`;
          throw new Error(message);
        }
        closeStoryModal();
        storiesState.stories = storiesState.stories.filter((item) => item.id !== storyId);
        renderStories(storiesState.stories);
        loadStories(true);
        window.dispatchEvent(new CustomEvent('story-deleted', { detail: { storyId } }));
      } catch (error) {
        console.error('Error eliminando historia', error);
        const message = error instanceof Error ? error.message : 'No se pudo eliminar la historia.';
        window.alert(message);
      } finally {
        storyModalDeleteButton.disabled = false;
        storyModalDeleteButton.textContent = '🗑 Eliminar';
      }
    }

    function openStoryCreateModal() {
      const authState = window.supAuth && typeof window.supAuth.getState === 'function' ? window.supAuth.getState() : null;
      const token = authState?.token;
      if (!token) {
        window.supAuth?.openAuthModal?.();
        return;
      }
      if (storyCreateModal) {
        storyCreateModal.style.display = 'flex';
      }
    }

    function closeStoryCreateModal() {
      if (storyCreateModal) {
        storyCreateModal.style.display = 'none';
      }
    }

    function renderStoryModalTrack(total, activeIndex) {
      if (!storyModalTrack) return;
      storyModalTrack.innerHTML = '';
      storyModalTrackBars = [];
      if (!total || total <= 1) {
        storyModalTrack.classList.remove('is-visible');
        return;
      }
      storyModalTrack.classList.add('is-visible');
      for (let i = 0; i < total; i += 1) {
        const wrapper = document.createElement('span');
        wrapper.className = 'story-modal-track-bar';
        if (i < activeIndex) wrapper.classList.add('is-complete');
        const fill = document.createElement('span');
        fill.style.width = i < activeIndex ? '100%' : '0%';
        wrapper.appendChild(fill);
        storyModalTrack.appendChild(wrapper);
        storyModalTrackBars.push(fill);
      }
    }

    function updateStoryModalNav(total) {
      const hasMultiple = total > 1;
      if (storyModalPrevButton) {
        storyModalPrevButton.disabled = currentModalStoryIndex <= 0;
        storyModalPrevButton.style.visibility = hasMultiple ? 'visible' : 'hidden';
      }
      if (storyModalNextButton) {
        storyModalNextButton.disabled = currentModalStoryIndex >= total - 1;
        storyModalNextButton.style.visibility = hasMultiple ? 'visible' : 'hidden';
      }
    }

    function updateStoryTrackProgress(progress) {
      if (!storyModalTrackBars.length) return;
      const clamped = Math.max(0, Math.min(1, progress));
      storyModalTrackBars.forEach((fill, index) => {
        if (!(fill instanceof HTMLElement)) return;
        if (index < currentModalStoryIndex) {
          fill.style.width = '100%';
          fill.parentElement?.classList.add('is-complete');
        } else if (index > currentModalStoryIndex) {
          fill.style.width = '0%';
          fill.parentElement?.classList.remove('is-complete');
        } else {
          fill.style.width = `${(clamped * 100).toFixed(2)}%`;
          if (clamped >= 1) {
            fill.parentElement?.classList.add('is-complete');
          } else {
            fill.parentElement?.classList.remove('is-complete');
          }
        }
      });
    }

    function populateStoryModal(story) {
      if (!story) return;
      const displayName = getStoryDisplayName(story);
      const avatarUrl = getStoryAvatarUrl(story);
      if (storyModalMedia) {
        storyModalMedia.innerHTML = '';
        const mediaUrl = safeMediaUrl(story.mediaUrl);
        if (mediaUrl) {
          const img = document.createElement('img');
          img.src = mediaUrl;
          img.alt = `Historia de ${displayName}`;
          img.loading = 'lazy';
          storyModalMedia.appendChild(img);
          storyModalMedia.style.display = 'block';
          storyModalMedia.setAttribute('aria-hidden', 'false');
        } else {
          storyModalMedia.style.display = 'none';
          storyModalMedia.setAttribute('aria-hidden', 'true');
        }
      }
      if (storyModalTitle) {
        storyModalTitle.textContent = story.title || displayName || 'Historia SUP';
      }
      if (storyModalAuthor) {
        storyModalAuthor.textContent = displayName;
      }
      if (storyModalAuthorMeta) {
        const dateLabel = formatStoryDate(story.publishedAt || story.updatedAt || story.createdAt);
        if (dateLabel) {
          storyModalAuthorMeta.textContent = `Publicado el ${dateLabel}`;
          storyModalAuthorMeta.style.display = 'block';
        } else {
          storyModalAuthorMeta.textContent = '';
          storyModalAuthorMeta.style.display = 'none';
        }
      }
      if (storyModalAvatar) {
        storyModalAvatar.innerHTML = '';
        storyModalAvatar.setAttribute('aria-hidden', 'true');
        if (avatarUrl) {
          const img = document.createElement('img');
          img.src = avatarUrl;
          img.alt = '';
          img.loading = 'lazy';
          storyModalAvatar.appendChild(img);
        } else {
          storyModalAvatar.textContent = getStoryInitials(displayName);
        }
      }
      if (storyModalFeatured) {
        storyModalFeatured.style.display = story.featured ? 'inline-flex' : 'none';
      }
      if (storyModalMeta) {
        const chips = [];
        if (story.spot) chips.push(`📍 ${story.spot}`);
        if (story.bestConditions) chips.push(`⚓ ${story.bestConditions}`);
        storyModalMeta.innerHTML = chips.map((bit) => `<span>${escapeHtml(bit)}</span>`).join('');
        storyModalMeta.style.display = chips.length ? 'flex' : 'none';
      }
      if (storyModalText) {
        storyModalText.textContent = story.body || '';
      }
      setStoryModalLikeState(story);
      if (storyModalDeleteButton) {
        const authState = window.supAuth && typeof window.supAuth.getState === 'function' ? window.supAuth.getState() : null;
        const isAdmin = Boolean(authState?.isAdmin);
        if (isAdmin) {
          storyModalDeleteButton.style.display = 'inline-flex';
          storyModalDeleteButton.disabled = false;
          storyModalDeleteButton.dataset.storyId = story.id || '';
          storyModalDeleteButton.textContent = '🗑 Eliminar';
        } else {
          storyModalDeleteButton.style.display = 'none';
          storyModalDeleteButton.dataset.storyId = '';
        }
      }
    }

    function stopStoryAutoAdvance() {
      if (storyAutoAdvanceFrame !== null) {
        cancelAnimationFrame(storyAutoAdvanceFrame);
        storyAutoAdvanceFrame = null;
      }
    }

    function startStoryAutoAdvance(resetProgress = false) {
      stopStoryAutoAdvance();
      const sorted = getSortedStories();
      if (!storyModal || storyModal.style.display !== 'flex' || sorted.length <= 1) return;
      if (resetProgress) {
        storyAutoAdvanceProgress = 0;
        updateStoryTrackProgress(0);
      }
      storyAutoAdvancePaused = false;
      const now = performance.now();
      storyAutoAdvanceStart = now - storyAutoAdvanceProgress * STORY_AUTO_ADVANCE_MS;
      storyAutoAdvanceFrame = requestAnimationFrame(storyAutoAdvanceStep);
    }

    function storyAutoAdvanceStep(timestamp) {
      if (storyAutoAdvancePaused) return;
      if (!storyAutoAdvanceStart) storyAutoAdvanceStart = timestamp;
      const elapsed = timestamp - storyAutoAdvanceStart;
      const progress = Math.min(1, elapsed / STORY_AUTO_ADVANCE_MS);
      storyAutoAdvanceProgress = progress;
      updateStoryTrackProgress(progress);
      if (progress >= 1) {
        storyAutoAdvanceFrame = null;
        showNextStory(true);
      } else {
        storyAutoAdvanceFrame = requestAnimationFrame(storyAutoAdvanceStep);
      }
    }

    function pauseStoryAutoAdvance() {
      storyAutoAdvancePaused = true;
      stopStoryAutoAdvance();
    }

    function resumeStoryAutoAdvance() {
      const sorted = getSortedStories();
      storyAutoAdvancePaused = false;
      if (!sorted.length || sorted.length <= 1) return;
      startStoryAutoAdvance();
    }

    function openStoryModalByIndex(index) {
      if (!storyModal) return;
      const sorted = getSortedStories();
      if (!sorted.length) return;
      const safeIndex = Math.max(0, Math.min(index, sorted.length - 1));
      const story = sorted[safeIndex];
      if (!story) return;
      currentModalStoryIndex = safeIndex;
      currentModalStoryId = story.id || null;
      currentModalStoryData = story;
      storyAutoAdvanceProgress = 0;
      populateStoryModal(story);
      updateStoryModalNav(sorted.length);
      renderStoryModalTrack(sorted.length, safeIndex);
      updateStoryRailActiveState();
      if (storiesRail) {
        const activeBubble = Array.from(storiesRail.children).find((node) => node instanceof HTMLElement && node.dataset.storyId === currentModalStoryId);
        if (activeBubble instanceof HTMLElement) {
          activeBubble.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
      }
      storyModal.style.display = 'flex';
      if (sorted.length > 1) {
        startStoryAutoAdvance(true);
      } else {
        stopStoryAutoAdvance();
        updateStoryTrackProgress(1);
      }
    }

    function openStoryModalById(storyId) {
      const sorted = getSortedStories();
      const index = sorted.findIndex((item) => item.id === storyId);
      if (index >= 0) {
        openStoryModalByIndex(index);
      }
    }

    function showNextStory(auto = false) {
      const sorted = getSortedStories();
      if (!sorted.length) return;
      if (currentModalStoryIndex + 1 >= sorted.length) {
        if (auto) {
          closeStoryModal();
        } else {
          updateStoryTrackProgress(1);
        }
        return;
      }
      openStoryModalByIndex(currentModalStoryIndex + 1);
    }

    function showPreviousStory() {
      const sorted = getSortedStories();
      if (!sorted.length || currentModalStoryIndex <= 0) return;
      openStoryModalByIndex(currentModalStoryIndex - 1);
    }

    function closeStoryModal() {
      if (!storyModal) return;
      storyModal.style.display = 'none';
      stopStoryAutoAdvance();
      storyAutoAdvancePaused = false;
      storyAutoAdvanceProgress = 0;
      storyModalTrackBars = [];
      if (storyModalTrack) {
        storyModalTrack.classList.remove('is-visible');
        storyModalTrack.innerHTML = '';
      }
      currentModalStoryId = null;
      currentModalStoryData = null;
      currentModalStoryIndex = -1;
      updateStoryRailActiveState();
      updateStoryModalNav(0);
      setStoryModalLikeState(null);
      if (storyModalDeleteButton) {
        storyModalDeleteButton.style.display = 'none';
        storyModalDeleteButton.dataset.storyId = '';
      }
    }

    function setStoriesLoading(isLoading) {
      storiesState.loading = isLoading;
      if (storiesRail) {
        storiesRail.setAttribute('aria-busy', String(isLoading));
      }
      if (storiesActivityLabel) {
        if (isLoading) {
          storiesActivityLabel.dataset.state = 'loading';
          storiesActivityLabel.textContent = 'Actualizando…';
        } else if (storiesActivityLabel.dataset.state !== 'error') {
          storiesActivityLabel.dataset.state = 'ready';
          storiesActivityLabel.textContent = 'Historias al día';
        }
      }
      if (isLoading && storiesEmpty) {
        storiesEmpty.style.display = 'block';
        storiesEmpty.innerHTML = '<p>⏳ Cargando historias…</p>';
      }
    }

    function loadStories(force = false) {
      if (!storiesRail || storiesState.loading) return;
      setStoriesLoading(true);
      const url = new URL(`${STORIES_API_BASE}/v1/stories`);
      if (force) {
        url.searchParams.set('cb', String(Date.now()));
      }
      const authState = window.supAuth && typeof window.supAuth.getState === 'function' ? window.supAuth.getState() : null;
      const headers = {};
      if (authState?.token) {
        headers.Authorization = `Bearer ${authState.token}`;
      }
      fetch(url.toString(), { cache: 'no-store', headers })
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          return response.json();
        })
        .then((data) => {
          storiesState.stories = Array.isArray(data.stories) ? data.stories : [];
          renderStories(storiesState.stories);
          if (storiesActivityLabel) {
            storiesActivityLabel.dataset.state = 'ready';
            storiesActivityLabel.textContent = 'Historias al día';
          }
        })
        .catch((error) => {
          console.error('Error cargando historias', error);
          if (storiesEmpty) {
            storiesEmpty.style.display = 'block';
            storiesEmpty.innerHTML = '<p>⚠️ No pudimos cargar las historias. Intenta nuevamente más tarde.</p>';
          }
          if (storiesActivityLabel) {
            storiesActivityLabel.dataset.state = 'error';
            storiesActivityLabel.textContent = 'Reintentaremos en segundos…';
          }
        })
        .finally(() => {
          setStoriesLoading(false);
        });
    }

    window.addEventListener('sup-auth-changed', () => loadStories(true));
    storyCreateButtons.forEach((button) => {
      button.addEventListener('click', (event) => {
        event.preventDefault();
        openStoryCreateModal();
      });
    });
    storyCreateCloseButton?.addEventListener('click', (event) => {
      event.preventDefault();
      closeStoryCreateModal();
    });
    storyModalClose?.addEventListener('click', closeStoryModal);
    storyModalPrevButton?.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      showPreviousStory();
    });
    storyModalNextButton?.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      showNextStory();
    });
    storyModalLikeButton?.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      const storyId = storyModalLikeButton.dataset.storyId;
      if (storyId) toggleStoryLike(storyId);
    });
    storyModalDeleteButton?.addEventListener('click', async (event) => {
      event.preventDefault();
      event.stopPropagation();
      if (!currentModalStoryId) return;
      await deleteStoryFromModal(currentModalStoryId);
    });
    storyModal?.addEventListener('click', (event) => {
      if (event.target === storyModal) {
        closeStoryModal();
      }
    });
    storyModalBody?.addEventListener('pointerdown', () => pauseStoryAutoAdvance());
    storyModalBody?.addEventListener('pointerup', () => resumeStoryAutoAdvance());
    storyModalBody?.addEventListener('pointercancel', () => resumeStoryAutoAdvance());
    storyModalBody?.addEventListener('pointerleave', () => resumeStoryAutoAdvance());
    storyModalBody?.addEventListener('click', (event) => {
      if (!storyModal || storyModal.style.display !== 'flex') return;
      if (event.defaultPrevented) return;
      const interactive = event.target instanceof Element
        ? event.target.closest('button, a, input, textarea, label')
        : null;
      if (interactive) return;
      const rect = storyModalBody.getBoundingClientRect();
      const clickX = event.clientX - rect.left;
      if (Number.isNaN(clickX)) return;
      if (clickX < rect.width / 2) {
        showPreviousStory();
      } else {
        showNextStory();
      }
    });
    storyCreateModal?.addEventListener('click', (event) => {
      if (event.target === storyCreateModal) {
        closeStoryCreateModal();
      }
    });
    window.addEventListener('story-saved', closeStoryCreateModal);
    window.addEventListener('keydown', (event) => {
      if (!storyModal || storyModal.style.display !== 'flex') return;
      const activeElement = document.activeElement;
      if (activeElement && ['INPUT', 'TEXTAREA'].includes(activeElement.tagName)) return;
      if (event.key === 'ArrowRight') {
        event.preventDefault();
        showNextStory();
      } else if (event.key === 'ArrowLeft') {
        event.preventDefault();
        showPreviousStory();
      } else if (event.key === 'Escape') {
        closeStoryModal();
      }
    });

    function startStoriesAutoRefresh() {
      if (storiesRefreshInterval !== null) return;
      storiesRefreshInterval = window.setInterval(() => {
        if (document.hidden || storiesState.loading) return;
        loadStories(true);
      }, STORIES_REFRESH_INTERVAL_MS);
    }

    function stopStoriesAutoRefresh() {
      if (storiesRefreshInterval !== null) {
        clearInterval(storiesRefreshInterval);
        storiesRefreshInterval = null;
      }
    }

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        stopStoriesAutoRefresh();
      } else {
        loadStories(true);
        startStoriesAutoRefresh();
      }
    });

    if (localStorage.getItem("modoOscuro") === "true") {
      document.body.classList.add("oscuro");
    }

    function verCondicionesActuales() {
      if (!pronostico) return;

      const ahora = new Date();
      const horaActual = ahora.getHours();
      const bloques = pronostico && Array.isArray(pronostico.hoy) ? pronostico.hoy : [];
      if (!bloques.length) return;

      let bloqueActual = bloques.find(b => {
        const h = parseInt(b.hora.split(":")[0], 10);
        return h >= horaActual;
      });

      if (!bloqueActual) bloqueActual = bloques[bloques.length - 1];
      const nivelClass = bloqueActual.nivel.toLowerCase();

      const modal = document.getElementById("modal-actual");
      const contenido = document.getElementById("modal-contenido");

      contenido.innerHTML = `
        <button onclick="cerrarModal()" class="cerrar-modal">✕</button>
        <h3 class="modal-title">Ahora (aprox ${bloqueActual.hora} hrs)</h3>
        <span class="nivel-pill ${nivelClass}">${bloqueActual.nivel}</span>
        <div class="modal-metrics">
          <div class="metric">
            <span class="label">Viento</span>
            <span class="value">${bloqueActual.viento}</span>
            <span class="hint">${bloqueActual.direccionViento}</span>
          </div>
          <div class="metric">
            <span class="label">Oleaje</span>
            <span class="value">${bloqueActual.oleaje}</span>
            <span class="hint">${bloqueActual.direccionOleaje}</span>
          </div>
          <div class="metric">
            <span class="label">Temperatura del agua</span>
            <span class="value">${bloqueActual.temperatura}</span>
          </div>
        </div>
        <p class="modal-condiciones">${bloqueActual.condiciones}</p>
      `;

      modal.style.display = "flex";
    }

    function cerrarModal() {
      const modal = document.getElementById("modal-actual");
      if (modal) modal.style.display = "none";
    }

    const modalOverlay = document.getElementById("modal-actual");
    if (modalOverlay) {
      modalOverlay.addEventListener("click", event => {
        if (event.target === modalOverlay) {
          cerrarModal();
        }
      });
    }

    document.addEventListener("keydown", event => {
      if (event.key === "Escape") {
        cerrarModal();
        closeStoryModal();
      }
    });

    loadStories();
    startStoriesAutoRefresh();

    fetch(`data.json?cb=${Date.now()}`, { cache: "no-store" })
      .then(res => res.json())
      .then(data => {
        pronostico = data;
        const fechaBase = new Date();
        actualizarFechaVisor(fechaBase, "Hoy");

        renderizarPronostico("hoy");

        if (data.generado) {
          const generado = document.getElementById("generado-el");
          if (generado) {
            generado.innerHTML = `<strong>🕒 Datos generados:</strong> ${data.generado}`;
          }
        }

        mostrarHorariosMarea(data);
      })
      .catch(err => {
        console.error("Error cargando data.json", err);
      });
  </script>
  <script type="module" src="auth.js"></script>
</body>
</html>
